name: Reusable Build and Release

on:
  workflow_call:
    inputs:
      tag_name:
        description: "Tag to create (e.g. v1.0.0)"
        required: true
        type: string

      release_name:
        description: "Release display name (optional)"
        required: false
        type: string
        default: ""

      overwrite_release:
        description: "Delete existing release with same tag (true/false)"
        required: false
        type: string
        default: "true"

      draft:
        description: "Create draft release (true/false)"
        required: false
        type: string
        default: "false"

      prerelease:
        description: "Create prerelease (true/false)"
        required: false
        type: string
        default: "false"

      app_name:
        description: "Output application / game name"
        required: false
        type: string
        default: "Email adress generator"

      main_py_file:
        description: "Main python entry file"
        required: false
        type: string
        default: "generator.py"

      python_version:
        description: "Python version"
        required: false
        type: string
        default: "3.10"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      # ---------------- WINDOWS ----------------
      - name: Build Windows EXE
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $App = "${{ inputs.app_name }}"
          pyinstaller --onefile --noconsole --name "$App" "${{ inputs.main_py_file }}"

          if (!(Test-Path "dist\$App.exe")) {
            throw "Expected dist\$App.exe not found"
          }

          New-Item -ItemType Directory -Force -Path out | Out-Null
          Copy-Item "dist\$App.exe" "out\$App.exe" -Force

      # ---------------- LINUX ----------------
      - name: Build Linux binary
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          APP="${{ inputs.app_name }}"

          pyinstaller  --noconsole --onefile --name "$APP" "${{ inputs.main_py_file }}"

          if [ ! -f "dist/$APP" ]; then
            echo "Expected dist/$APP not found"
            ls -la dist || true
            exit 1
          fi

          mkdir -p out
          cp "dist/$APP" "out/$APP"
          chmod +x "out/$APP"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ runner.os }}
          path: out/

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: downloaded

      - name: Prepare release assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release_assets

          cp downloaded/* release_assets/ || true
          chmod +x release_assets/* || true

          echo "Assets:"
          ls -la release_assets

      - name: Generate SHA256SUMS.txt
        shell: bash
        run: |
          set -euo pipefail
          cd release_assets

          if [ "$(ls -A .)" = "" ]; then
            echo "No assets found"
            exit 1
          fi

          sha256sum * | LC_ALL=C sort > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Delete existing release (optional)
        if: ${{ inputs.overwrite_release == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag_name }}"

          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            gh release delete "$TAG" --repo "$GITHUB_REPOSITORY" --yes --cleanup-tag
          fi

      - name: Create release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ inputs.tag_name }}"
          TITLE_INPUT="${{ inputs.release_name }}"
          DRAFT="${{ inputs.draft }}"
          PRERELEASE="${{ inputs.prerelease }}"

          if [ -n "$TITLE_INPUT" ]; then
            TITLE="$TITLE_INPUT"
          else
            TITLE="Release $TAG"
          fi

          FLAGS=()
          [ "$DRAFT" = "true" ] && FLAGS+=(--draft)
          [ "$PRERELEASE" = "true" ] && FLAGS+=(--prerelease)

          gh release create "$TAG" release_assets/* \
            --repo "$GITHUB_REPOSITORY" \
            --title "$TITLE" \
            --notes "" \
            "${FLAGS[@]}"
